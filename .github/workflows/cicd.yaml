name: CI/CD

# avoid running on changes to chart/k8s/README so commits to helm won't retrigger
on:
  push:
    branches:
      - main
    paths-ignore:
      - 'helm/**'
      - 'k8s/**'
      - 'README.md'

# allow workflow to push changes using GITHUB_TOKEN
permissions:
  contents: write   # needed to push commits
  id-token: write
  packages: write

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/go-web-app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go 1.22
        uses: actions/setup-go@v4
        with:
          go-version: 1.22

      - name: Build
        run: go build -o go-web-app

      - name: Test
        run: go test ./...

      - name: Set image tag (short sha + run number)
        id: set-tag
        run: |
          # Use short sha to tag image and make it human friendly
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

  code-quality:
    name: Lint (golangci-lint)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.56.2

  push:
    name: Build & push Docker image
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}
            ${{ env.IMAGE_NAME }}:latest

  update-helm:
    name: Update Helm chart with new tag
    runs-on: ubuntu-latest
    needs: push
    steps:
      - name: Checkout repository (with write perms)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Show current helm values (for debugging)
        run: sed -n '1,120p' helm/go-web-app-chart/values.yaml || true

      - name: Replace tag in Helm values.yaml
        id: replace
        run: |
          IMAGE_TAG=${{ needs.build.outputs.image_tag }}
          FILE=helm/go-web-app-chart/values.yaml

          # make a backup
          cp "$FILE" "$FILE.bak"

          # Replace the line that starts with 'tag:' (works for simple yaml)
          # This keeps indentation and replaces value after `tag:`
          sed -E -i "s/^(\\s*tag:\\s*).*/\\1\"${IMAGE_TAG}\"/" "$FILE"

          # show diff for debug/visibility
          git --no-pager diff --no-color || true

          # indicate whether file changed
          if git status --porcelain | grep -q "helm/go-web-app-chart/values.yaml"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push Helm change (only if changed)
        if: steps.replace.outputs.changed == 'true'
        run: |
          git config user.email "rajeshgoruva@gmail.com"
          git config user.name "rajeshgoruvaa"
          git add helm/go-web-app-chart/values.yaml
          git commit -m "chore: update image tag to ${{ needs.build.outputs.image_tag }} [ci skip]"
          git push origin HEAD:main

      - name: No change to Helm chart
        if: steps.replace.outputs.changed == 'false'
        run: echo "Helm values.yaml unchanged; nothing to commit."
